from fastapi import FastAPI, Query, HTTPException
from pydantic import BaseModel
from typing import List, Optional
import psycopg2
from psycopg2.extras import RealDictCursor

# -----------------------------
# DATABASE CONFIG
# -----------------------------
DB_CONFIG = {
    "dbname": "vector_db",
    "user": "postgres",
    "password": "password",
    "host": "localhost",
    "port": 5432,
}

TABLE_NAME = "langchain_pg_embedding"

# -----------------------------
# FASTAPI APP
# -----------------------------
app = FastAPI(
    title="Team Ingestion Inventory API",
    description="Swagger API to fetch all ingested pages for a given team from LangChain PGVector",
    version="1.0.0",
)

# -----------------------------
# MODELS (Swagger-visible)
# -----------------------------
class Page(BaseModel):
    source: Optional[str]
    page: Optional[str]


class PagesResponse(BaseModel):
    team_name: str
    total_pages: int
    pages: List[Page]


def get_connection():
    return psycopg2.connect(**DB_CONFIG)


# -----------------------------
# SWAGGER ENDPOINT
# -----------------------------
@app.get(
    "/pages",
    response_model=PagesResponse,
    summary="Get all ingested pages for a team",
    description="Fetches the list of document pages ingested for the given team_name",
)
def get_pages_for_team(
    team_name: str = Query(
        ...,
        description="Team name used during ingestion (stored in cmetadata.team_name)",
        example="payments",
    )
):
    query = f"""
        SELECT DISTINCT
            cmetadata->>'source' AS source,
            cmetadata->>'page'   AS page
        FROM {TABLE_NAME}
        WHERE cmetadata->>'team_name' = %s
        ORDER BY source, page;
    """

    conn = get_connection()
    try:
        with conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute(query, (team_name,))
            rows = cur.fetchall()
    finally:
        conn.close()

    if not rows:
        raise HTTPException(
            status_code=404,
            detail=f"No pages found for team_name='{team_name}'"
        )

    return {
        "team_name": team_name,
        "total_pages": len(rows),
        "pages": rows,
    }
