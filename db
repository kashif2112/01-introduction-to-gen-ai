from fastapi import FastAPI, HTTPException
import psycopg2
from psycopg2.extras import RealDictCursor

# -----------------------------
# CONFIG â€” change only this
# -----------------------------
DB_CONFIG = {
    "dbname": "vector_db",
    "user": "postgres",
    "password": "password",
    "host": "localhost",
    "port": 5432,
}

TABLE_NAME = "langchain_pg_embedding"

# -----------------------------
# APP
# -----------------------------
app = FastAPI(title="LangChain PGVector Inventory API")

def get_connection():
    return psycopg2.connect(**DB_CONFIG)


@app.get("/teams/{team_name}/pages")
def get_ingested_pages(team_name: str):
    query = f"""
        SELECT DISTINCT
            metadata->>'source' AS source,
            metadata->>'page'   AS page
        FROM {TABLE_NAME}
        WHERE metadata->>'team' = %s
        ORDER BY source, page;
    """

    conn = get_connection()
    try:
        with conn.cursor(cursor_factory=RealDictCursor) as cur:
            cur.execute(query, (team_name,))
            rows = cur.fetchall()
    finally:
        conn.close()

    if not rows:
        raise HTTPException(
            status_code=404,
            detail=f"No pages found for team '{team_name}'"
        )

    return {
        "team": team_name,
        "total_pages": len(rows),
        "pages": rows
    }
